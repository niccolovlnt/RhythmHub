<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RhythmHub - My Account</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="icon" href="iconPNG.png" type="image/png">
  </head>

  <body style="background: url('def2.png') no-repeat center center fixed;
  -webkit-background-size: cover;
  -moz-background-size: cover;
  background-size: cover;
  -o-background-size: cover;
  font-family: 'Helvetica Neue';">

  <style>
        .dropdown-menu {
    max-height: 200px; /* Set a maximum height */
    overflow-y: auto; /* Enable vertical scrolling */
    }

    .checkbox-menu li label {
    display: block;
    padding: 3px 10px;
    clear: both;
    font-weight: normal;
    line-height: 1.42857143;
    color: #333;
    white-space: nowrap;
    margin:0;
    transition: background-color .4s ease;
}
.checkbox-menu li input {
    margin: 0px 5px;
    top: 2px;
    position: relative;
}

.checkbox-menu li.active label {
    background-color: #cbcbff;
    font-weight:bold;
}

.checkbox-menu li label:hover,
.checkbox-menu li label:focus {
    background-color: #f5f5f5;
}

.checkbox-menu li.active label:hover,
.checkbox-menu li.active label:focus {
    background-color: #b8b8ff;
}
  </style>
  
    <div id="menu"></div>   
    <div class="container">
    <div class="row p-3" style="margin-top: 60px;">
            <div class="col-sm-12 col-md-6 col-lg-6 mt-3 mx-auto">
                <h1 id="username" style="color: rgb(77,98,188);"><strong><span id="username"></span> </strong></h1>
                <div class="card">
                    <h5 class="card-header"> <strong>Update your data</strong></h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <h5 class="card-title">First Name</h5>
                            <div class="mb-3">
                                <input type="name" class="form-control" id="name" placeholder="">
                            </div>
                        </li>
                        <li class="list-group-item">
                            <h5 class="card-title">Last Name</h5>
                            <div class="mb-3">
                                <input type="surname" class="form-control" id="surname" placeholder="">
                            </div>
                        </li>
                        <li class="list-group-item">
                            <h5 class="card-title">E-Mail</h5>
                            <div class="mb-3">
                                <input type="email" id="email" class="form-control" placeholder="">
                            </div>
                        </li>
                        <li class="list-group-item">
                            <h5 class="card-title">Username</h5>
                            <div class="mb-3">
                                <input type="username" id="us" class="form-control" placeholder="">
                            </div>
                        </li>
                        <li class="list-group-item">
                            <h5 class="card-title">Password</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="password">
                                <label class="form-check-label" for="flexSwitchCheckDefault">Change Password</label>
                            </div>
                            <div id="changeps" class="mt-2 mb-2"></div>
                        </li>
                        <li class="list-group-item">
                            <h5 class="card-title">Favorite Genres</h5>
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                  Select Genres
                                </button>
                                <ul class="dropdown-menu checkbox-menu allow-focus" aria-labelledby="dropdownMenuButton" id="genreDropdown">
                                </ul>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <h5 class="card-title">Favorite Artists</h5>
                            <div class="input-group">
                                <input type="text" class="form-control" aria-label="Text input with dropdown button" onkeyup="showArtist(this.value)" placeholder="Artists">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" fill="none" width="20px" height="20px">
                                    <path d="M51.414 49.142l-14.85-14.85a20.564 20.564 0 004.95-13.292C41.514 9.617 32.397.5 21.257.5S1 9.617 1 20.757s9.117 20.257 20.257 20.257a20.564 20.564 0 0013.292-4.95l14.85 14.85a2.998 2.998 0 004.242 0 2.998 2.998 0 000-4.242zM3 20.757C3 11.163 11.163 3 20.757 3S38.514 11.163 38.514 20.757 30.351 38.514 20.757 38.514 3 30.351 3 20.757z" fill="#ffffff"/>
                                  </svg>
                                </button>
                                  <ul class="dropdown-menu dropdown-menu-end allow-focus checkbox-menu" aria-labelledby="dropdownMenuButton2" id="artistDropdown">
                                </ul>
                            </div>
                        </li>
                      </ul>
                </div>

                <div class="card mt-3">
                    <div class="col text-center g-2 p-2">
                        <a class="btn btn-primary d-flex" onclick="updateAcc()">Update Account</a>
                      </div>
                </div>
            </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="menu.js"></script>
<script src="account.js"></script>

<script>
    $(".checkbox-menu").on("change", "input[type='checkbox']", function() {
        $(this).closest("li").toggleClass("active", this.checked);
    });

    $(document).on('click', '.allow-focus', function (e) {
        e.stopPropagation();
    });

    if(localStorage.getItem('user')!=null){
    var user=JSON.parse(localStorage.getItem('user'))
    document.getElementById('username').innerHTML= "@"+user.username
    document.getElementById("name").value=user.name
    document.getElementById('surname').value=user.surname
    document.getElementById('email').value=user.mail
    document.getElementById('us').value=user.username
    fetch('/api/genres')
    .then(response => {
        return response.json()
    })
    .then(data => {
        var dropdownMenu = document.querySelector(".dropdown-menu.allow-focus");
        for (i = 0; i < data.genres.length; i++) {
            var li = document.createElement("li");
            var label = document.createElement("label");
            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = data.genres[i];
            // Check the checkbox if the user's genres include this genre
            if (user.genres.includes(data.genres[i])) {
                checkbox.checked = true;
            }
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(data.genres[i]));
            li.appendChild(label);
            dropdownMenu.appendChild(li);
        }
    })
    }

    function showArtist(query){
    localStorage.removeItem("query")
    localStorage.setItem("query", query)
    if(query.length < 1){
      return
    }
    fetch(`/spoty/artists?query=${query}`)
    .then(response => {
      return response.json()
    })
    .then(data =>{
      // Get the dropdown menu
      var dropdownMenu = document.querySelector('#artistDropdown');

      // Clear the dropdown menu
      dropdownMenu.innerHTML = '';

      // Add each artist to the dropdown menu
      data.artists.items.forEach(artist => {
        var li = document.createElement('li');
        var label = document.createElement('label');
        var input = document.createElement('input');
        input.type = 'checkbox';
        input.value = artist.name;
        if (user.artists.includes(artist.name)) {
            input.checked = true;
        }
        label.appendChild(input);
        label.appendChild(document.createTextNode(' ' + artist.name));
        li.appendChild(label);
        dropdownMenu.appendChild(li);
      });
    })
    }

    document.addEventListener('DOMContentLoaded', function(){
        var checkbox=document.getElementById('password')
        checkbox.addEventListener('change', function(){
            if(this.checked){
                const psw=document.getElementById('changeps')
                psw.innerHTML=`
                <div class="form-floating mt-3">
                    <input type="password" id="pass1" class="form-control" required>
                    <label for="pass1">Insert new password:</label>
                </div>
                <div class="form-floating mt-3">
                    <input type="password" id="pass2" class="form-control" required>
                    <label for="pass2">Re-insert your password:</label>
                    <span id="valid"></span>
                </div>
                `;
            }else{
                var psw=document.getElementById('changeps')
                psw.innerHTML=``;
            }
        })
    })
    
    function updateAcc(){
        var ps1=document.getElementById('pass1')
        if(ps1 != null){
            var ps2=document.getElementById('pass2')
            if(ps1.value!==ps2.value){
                ps2.classList.add("is-invalid")
                var labpsw=document.querySelector('label[for="pass2"]')
                labpsw.textContent="Password does not match"
            }else if(ps1.value.length<8){
                ps1.classList.add("is-invalid")
                var labpsw=document.querySelector('label[for="pass1"]')
                labpsw.textContent="Password must be at least 8 characters long"
            }
            else{
                var name=document.getElementById('name')
                var surname=document.getElementById('surname')
                var username=document.getElementById('us')
                var mail=document.getElementById('email')
                var pass=document.getElementById('pass1')
                var gen=document.getElementById('gen')
                var generi_selezionati = document.querySelectorAll("#genreDropdown :checked");
                var generi_selezionati_values = []
                for (let i = 0; i < generi_selezionati.length; i++) {
                    generi_selezionati_values.push(generi_selezionati[i].value)
                }
                var user = JSON.parse(localStorage.getItem('user'));
                var savedArtists = user.artists || [];
                var artisti_selezionati = document.querySelectorAll("#artistDropdown :checked");
                var artisti_selezionati_values = []
                for (let i = 0; i < artisti_selezionati.length; i++) {
                    artisti_selezionati_values.push(artisti_selezionati[i].value)
                }
                var allArtists = [...new Set([...savedArtists, ...artisti_selezionati_values])];
                var data={
                    name: name.value,
                    surname: surname.value,
                    username: username.value,
                    mail: mail.value,
                    pass: pass.value,
                    genres: generi_selezionati_values,
                    artists: allArtists
                }
                var us=JSON.parse(localStorage.getItem('user'))
                var id=us._id
                fetch(`/update/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    return response.json()
                })
                .then(async updatedUser =>{
                    localStorage.removeItem('user')
                    window.location.href="login.html"
                })
                .catch(error => {
                    console.error("Error: ", error)
                })
            }
        }else{
            var name=document.getElementById('name')
                var surname=document.getElementById('surname')
                var username=document.getElementById('us')
                var mail=document.getElementById('email')
                var gen=document.getElementById('gen')
                var generi_selezionati = document.querySelectorAll("#genreDropdown :checked");
                var generi_selezionati_values = []
                for (let i = 0; i < generi_selezionati.length; i++) {
                    generi_selezionati_values.push(generi_selezionati[i].value)
                }
                var user = JSON.parse(localStorage.getItem('user'));
                var savedArtists = user.artists || [];

                var artisti_selezionati = document.querySelectorAll("#artistDropdown :checked");
                var artisti_selezionati_values = []
                for (let i = 0; i < artisti_selezionati.length; i++) {
                    artisti_selezionati_values.push(artisti_selezionati[i].value)
                }

                // Filter out the de-selected artists from the saved artists
                savedArtists = savedArtists.filter(artist => artisti_selezionati_values.includes(artist));

                var allArtists = [...new Set([...savedArtists, ...artisti_selezionati_values])];

                var data = {
                    name: name.value,
                    surname: surname.value,
                    username: username.value,
                    mail: mail.value,
                    genres: generi_selezionati_values,
                    artists: allArtists
                }
                
                var us=JSON.parse(localStorage.getItem('user'))
                var id=us._id
                fetch(`/update/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    return response.json()
                })
                .then(async updatedUser =>{
                    localStorage.removeItem('user')
                    localStorage.setItem('user', JSON.stringify(updatedUser))
                    window.location.href="settings.html"
                })
                .catch(error => {
                    console.error("Error: ", error)
                })
            }
        }

</script>

  </body>
</html>